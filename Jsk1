// frontend/src/components/EmployeeForm.jsx
import React, { useState, useEffect } from 'react';
import {
    Container,
    Paper,
    TextField,
    Button,
    Typography,
    Box,
    Grid,
    MenuItem,
    Alert,
    CircularProgress
} from '@mui/material';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDateFns } from '@mui/x-date-pickers/AdapterDateFns';
import { hcmApi } from '../services/api';

const EmployeeForm = ({ employeeId, isEdit = false }) => {
    const [loading, setLoading] = useState(false);
    const [submitting, setSubmitting] = useState(false);
    const [error, setError] = useState(null);
    const [success, setSuccess] = useState(false);
    
    const [formData, setFormData] = useState({
        firstName: '',
        lastName: '',
        email: '',
        phone: '',
        dob: null,
        gender: '',
        businessUnit: '',
        department: '',
        job: '',
        location: '',
        hireDate: null,
    });

    const [departments, setDepartments] = useState([]);
    const [jobs, setJobs] = useState([]);

    useEffect(() => {
        fetchLookupData();
        if (isEdit && employeeId) {
            fetchEmployeeData();
        }
    }, [employeeId, isEdit]);

    const fetchLookupData = async () => {
        try {
            // Fetch departments and jobs from Oracle HCM
            // Note: You'll need to implement these endpoints in your backend
            const deptResponse = await hcmApi.getDepartments();
            const jobsResponse = await hcmApi.getJobs();
            
            setDepartments(deptResponse.data || []);
            setJobs(jobsResponse.data || []);
        } catch (err) {
            console.error('Error fetching lookup data:', err);
        }
    };

    const fetchEmployeeData = async () => {
        try {
            setLoading(true);
            const response = await hcmApi.getEmployeeById(employeeId);
            setFormData({
                firstName: response.data.FirstName || '',
                lastName: response.data.LastName || '',
                email: response.data.Email || '',
                phone: response.data.WorkPhone || '',
                dob: response.data.DateOfBirth || null,
                gender: response.data.Gender || '',
                businessUnit: response.data.BusinessUnit || '',
                department: response.data.Department || '',
                job: response.data.Job || '',
                location: response.data.Location || '',
                hireDate: response.data.HireDate || null,
            });
        } catch (err) {
            setError('Failed to load employee data');
        } finally {
            setLoading(false);
        }
    };

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({
            ...prev,
            [name]: value
        }));
    };

    const handleDateChange = (name, date) => {
        setFormData(prev => ({
            ...prev,
            [name]: date
        }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setSubmitting(true);
        setError(null);
        
        try {
            const formattedData = {
                ...formData,
                dob: formData.dob ? new Date(formData.dob).toISOString().split('T')[0] : '',
                hireDate: formData.hireDate ? new Date(formData.hireDate).toISOString().split('T')[0] : '',
            };

            if (isEdit) {
                // Update employee - you'll need to implement update endpoint
                // await hcmApi.updateEmployee(employeeId, formattedData);
            } else {
                await hcmApi.createEmployee(formattedData);
            }
            
            setSuccess(true);
            setTimeout(() => {
                window.location.href = '/employees';
            }, 2000);
        } catch (err) {
            setError(err.response?.data?.message || 'Failed to save employee');
        } finally {
            setSubmitting(false);
        }
    };

    if (loading) {
        return (
            <Container>
                <Box display="flex" justifyContent="center" p={3}>
                    <CircularProgress />
                </Box>
            </Container>
        );
    }

    return (
        <LocalizationProvider dateAdapter={AdapterDateFns}>
            <Container maxWidth="md" sx={{ mt: 4, mb: 4 }}>
                <Paper sx={{ p: 4 }}>
                    <Typography variant="h5" component="h1" gutterBottom>
                        {isEdit ? 'Edit Employee' : 'Add New Employee'}
                    </Typography>

                    {error && (
                        <Alert severity="error" sx={{ mb: 2 }}>
                            {error}
                        </Alert>
                    )}
                    
                    {success && (
                        <Alert severity="success" sx={{ mb: 2 }}>
                            Employee {isEdit ? 'updated' : 'created'} successfully!
                        </Alert>
                    )}

                    <form onSubmit={handleSubmit}>
                        <Grid container spacing={3}>
                            <Grid item xs={12} sm={6}>
                                <TextField
                                    required
                                    fullWidth
                                    label="First Name"
                                    name="firstName"
                                    value={formData.firstName}
                                    onChange={handleChange}
                                />
                            </Grid>
                            <Grid item xs={12} sm={6}>
                                <TextField
                                    required
                                    fullWidth
                                    label="Last Name"
                                    name="lastName"
                                    value={formData.lastName}
                                    onChange={handleChange}
                                />
                            </Grid>
                            <Grid item xs={12} sm={6}>
                                <TextField
                                    required
                                    fullWidth
                                    label="Email"
                                    name="email"
                                    type="email"
                                    value={formData.email}
                                    onChange={handleChange}
                                />
                            </Grid>
                            <Grid item xs={12} sm={6}>
                                <TextField
                                    fullWidth
                                    label="Phone"
                                    name="phone"
                                    value={formData.phone}
                                    onChange={handleChange}
                                />
                            </Grid>
                            <Grid item xs={12} sm={6}>
                                <DatePicker
                                    label="Date of Birth"
                                    value={formData.dob}
                                    onChange={(date) => handleDateChange('dob', date)}
                                    renderInput={(params) => <TextField {...params} fullWidth />}
                                />
                            </Grid>
                            <Grid item xs={12} sm={6}>
                                <TextField
                                    select
                                    fullWidth
                                    label="Gender"
                                    name="gender"
                                    value={formData.gender}
                                    onChange={handleChange}
                                >
                                    <MenuItem value="M">Male</MenuItem>
                                    <MenuItem value="F">Female</MenuItem>
                                    <MenuItem value="U">Unspecified</MenuItem>
                                </TextField>
                            </Grid>
                            <Grid item xs={12} sm={6}>
                                <TextField
                                    required
                                    fullWidth
                                    label="Business Unit"
                                    name="businessUnit"
                                    value={formData.businessUnit}
                                    onChange={handleChange}
                                />
                            </Grid>
                            <Grid item xs={12} sm={6}>
                                <TextField
                                    select
                                    fullWidth
                                    label="Department"
                                    name="department"
                                    value={formData.department}
                                    onChange={handleChange}
                                >
                                    {departments.map((dept) => (
                                        <MenuItem key={dept.id} value={dept.name}>
                                            {dept.name}
                                        </MenuItem>
                                    ))}
                                </TextField>
                            </Grid>
                            <Grid item xs={12} sm={6}>
                                <TextField
                                    select
                                    fullWidth
                                    label="Job"
                                    name="job"
                                    value={formData.job}
                                    onChange={handleChange}
                                >
                                    {jobs.map((job) => (
                                        <MenuItem key={job.id} value={job.name}>
                                            {job.name}
                                        </MenuItem>
                                    ))}
                                </TextField>
                            </Grid>
                            <Grid item xs={12} sm={6}>
                                <TextField
                                    fullWidth
                                    label="Location"
                                    name="location"
                                    value={formData.location}
                                    onChange={handleChange}
                                />
                            </Grid>
                            <Grid item xs={12} sm={6}>
                                <DatePicker
                                    required
                                    label="Hire Date"
                                    value={formData.hireDate}
                                    onChange={(date) => handleDateChange('hireDate', date)}
                                    renderInput={(params) => <TextField {...params} fullWidth />}
                                />
                            </Grid>
                        </Grid>

                        <Box sx={{ mt: 3, display: 'flex', gap: 2 }}>
                            <Button
                                type="submit"
                                variant="contained"
                                color="primary"
                                disabled={submitting}
                            >
                                {submitting ? <CircularProgress size={24} /> : 'Save'}
                            </Button>
                            <Button
                                variant="outlined"
                                onClick={() => window.history.back()}
                            >
                                Cancel
                            </Button>
                        </Box>
                    </form>
                </Paper>
            </Container>
        </LocalizationProvider>
    );
};

export default EmployeeForm;
